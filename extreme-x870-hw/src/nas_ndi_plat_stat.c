/*
 * Copyright (c) 2016 Dell Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * THIS CODE IS PROVIDED ON AN  *AS IS* BASIS, WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT
 * LIMITATION ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS
 * FOR A PARTICULAR PURPOSE, MERCHANTABLITY OR NON-INFRINGEMENT.
 *
 * See the Apache Version 2.0 License for specific language governing
 * permissions and limitations under the License.
 */

/*
 * filename: nas_ndi_plat_stat.c
 */

#include "nas_ndi_plat_stat.h"
#include "event_log.h"
#include "dell-interface.h"
#include "ietf-interfaces.h"
#include <string.h>

static uint64_t if_stat_ids[] = {
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_IF_OUT_QLEN  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_DROP_EVENTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_MULTICAST_PKTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_BROADCAST_PKTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_UNDERSIZE_PKTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_FRAGMENTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OVERSIZE_PKTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_RX_OVERSIZE_PKTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_TX_OVERSIZE_PKTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_JABBERS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_PKTS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_COLLISIONS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_CRC_ALIGN_ERRORS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_TX_NO_ERRORS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_RX_NO_ERRORS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_GREEN_DISCARD_DROPPED_PACKETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_YELLOW_DISCARD_DROPPED_PACKETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_RED_DISCARD_DROPPED_PACKETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_64_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_65_TO_127_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_128_TO_255_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_256_TO_511_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_512_TO_1023_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_1024_TO_1518_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_1519_TO_2047_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_2048_TO_4095_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_IN_PKTS_4096_TO_9216_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_64_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_65_TO_127_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_128_TO_255_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_256_TO_511_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_512_TO_1023_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_1024_TO_1518_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_1519_TO_2047_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_2048_TO_4095_OCTETS  ,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_ETHER_OUT_PKTS_4096_TO_9216_OCTETS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_OCTETS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_UNICAST_PKTS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_BROADCAST_PKTS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_MULTICAST_PKTS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_DISCARDS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_ERRORS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_UNKNOWN_PROTOS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_OUT_OCTETS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_OUT_UNICAST_PKTS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_OUT_BROADCAST_PKTS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_OUT_MULTICAST_PKTS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_OUT_DISCARDS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_OUT_ERRORS  ,
};

static uint64_t vlan_stat_ids[] = {
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_OCTETS  ,
    IF_INTERFACES_STATE_INTERFACE_STATISTICS_OUT_OCTETS,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_IN_PKTS,
    DELL_IF_IF_INTERFACES_STATE_INTERFACE_STATISTICS_OUT_PKTS,
};


static size_t stat_id_len [] = {
    sizeof(if_stat_ids)/sizeof(if_stat_ids[0]),
    sizeof(vlan_stat_ids)/sizeof(vlan_stat_ids[0]),
};


t_std_error ndi_plat_get_ids_len(nas_stat_type_t type, unsigned int * len){
    if(type >= NAS_STAT_IF && type<= NAS_STAT_VLAN){
        *len = stat_id_len[type];
        return STD_ERR_OK;
    }

    EV_LOG(ERR,INTERFACE,0,"NAS-STAT","Invlaid Stat Type passed");
    return STD_ERR(NPU,PARAM,0);
}


t_std_error ndi_plat_port_stat_list_get(uint64_t * list, unsigned int *len){

    if(list == NULL){
        EV_LOG(ERR,NPU,0,"PLATFORM-STAT","NULL List passed to get counters id");
        return STD_ERR(NPU,PARAM,0);
    }

    unsigned int list_len = 0;
    unsigned int supported_ids_len = stat_id_len[NAS_STAT_IF];
    list_len = *len < supported_ids_len ? *len : supported_ids_len;

    if(list_len < supported_ids_len){
        EV_LOG(INFO,INTERFACE,0,"NAS-STAT","List size %d smaller than supported ids %d",
               *len,supported_ids_len);
    }

    memcpy(list,if_stat_ids,list_len*sizeof(if_stat_ids[0]));
    *len = list_len;
    return STD_ERR_OK;
}


t_std_error ndi_plat_vlan_stat_list_get(uint64_t *list, unsigned int *len){

    if(list == NULL){
        EV_LOG(ERR,NPU,0,"PLATFORM-STAT","NULL List passed to get counters id");
        return STD_ERR(NPU,PARAM,0);
    }

    unsigned vlan_stat_id_len = stat_id_len[NAS_STAT_VLAN];
    unsigned int list_len = 0;
    list_len = *len < vlan_stat_id_len ? *len : vlan_stat_id_len;

    if(list_len < vlan_stat_id_len){
        EV_LOG(ERR,NPU,0,"NAS-STAT","List size %d smaller than supported ids %d",
               *len,vlan_stat_id_len);
    }

    memcpy(list,vlan_stat_ids,list_len*sizeof(vlan_stat_ids[0]));
    *len = list_len;
    return STD_ERR_OK;
}
